---
import AdminSidebarLayout from '../../layouts/AdminLayout.astro';
import { newsletterQueries } from '../../lib/database.js';

// Definir tipos
interface NewsletterSubscription {
  id: number;
  email: string;
  type: string;
  status: string;
  source: string;
  metadata?: string;
  subscribed_at: string;
  unsubscribed_at?: string;
}

interface NewsletterStat {
  type: string;
  total: number;
  active: number;
  unsubscribed: number;
}

// Obtener datos con tipado correcto
const stats = newsletterQueries.getStats.all() as NewsletterStat[];
const allSubscriptions = newsletterQueries.getAll.all() as NewsletterSubscription[];

// Variables para alertas y datos
let message = '';
let error = '';
let subscriptions = allSubscriptions ?? [];
---

<AdminSidebarLayout title="Newsletter - Suscripciones">
  <div class="p-8">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-8 pb-4 border-b border-blue-200">
      <div class="mb-4 lg:mb-0">
        <h1 class="text-2xl lg:text-3xl font-bold text-blue-800 mb-2">Gestión de Newsletter</h1>
        <p class="text-blue-600">Administra las suscripciones de email</p>
      </div>
      <button 
        id="export-csv"
        class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-semibold px-6 py-3 rounded-lg hover:from-blue-700 hover:to-cyan-700 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl"
      >
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Exportar CSV
      </button>
    </div>
    <!-- Alertas de éxito/error -->
    {message && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6 flex items-center gap-2">
        <i class="fas fa-check-circle"></i>
        <span>{message}</span>
      </div>
    )}
    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6 flex items-center gap-2">
        <i class="fas fa-exclamation-circle"></i>
        <span>{error}</span>
      </div>
    )}
    <!-- Mensaje cuando no hay suscripciones -->
    {Array.isArray(subscriptions) && subscriptions.length === 0 && (
      <div class="flex flex-col items-center justify-center py-16">
        <div class="bg-white rounded-xl shadow-lg p-8 flex flex-col items-center">
          <i class="fas fa-envelope-open-text text-4xl text-blue-500 mb-4"></i>
          <h2 class="text-xl font-semibold text-gray-800 mb-2">No hay suscripciones configuradas</h2>
          <p class="text-gray-600 mb-6">Comienza agregando la primera suscripción al newsletter</p>
          <button 
            id="btn-nueva-suscripcion"
            class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-semibold px-6 py-3 rounded-lg hover:from-blue-700 hover:to-cyan-700 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Nueva Suscripción
          </button>
        </div>
      </div>
    )}

    <!-- Estadísticas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      {stats.map((stat) => (
        <div class="bg-white rounded-lg shadow-sm p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600 capitalize">{stat.type}</p>
              <p class="text-2xl font-bold text-[#035AA6]">{stat.active}</p>
              <p class="text-sm text-gray-500">de {stat.total} total</p>
            </div>
            <div class="w-12 h-12 bg-[#11B4D9]/10 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-[#035AA6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
              </svg>
            </div>
          </div>
          <div class="mt-4">
            <div class="flex justify-between text-sm">
              <span class="text-green-600">Activos: {stat.active}</span>
              <span class="text-red-600">Dados de baja: {stat.unsubscribed}</span>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- Formulario agregar suscripción -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <h2 class="text-lg font-semibold text-[#0D0D0D] mb-4">Agregar Suscripción</h2>
      <form id="add-subscription-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
          <input 
            type="email" 
            name="email" 
            id="email" 
            required 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#035AA6] focus:border-transparent"
            placeholder="email@ejemplo.com"
          >
        </div>
        <div>
          <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
          <select 
            name="type" 
            id="type" 
            required 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#035AA6] focus:border-transparent"
          >
            <option value="blog">Blog</option>
            <option value="career">Carrera</option>
            <option value="general">General</option>
          </select>
        </div>
        <div class="flex items-end">
          <button 
            type="submit" 
            class="w-full px-4 py-2 bg-[#035AA6] text-white rounded-lg hover:bg-[#07598C] transition-colors"
          >
            Agregar
          </button>
        </div>
      </form>
    </div>

    <!-- Lista de suscripciones -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-[#0D0D0D]">Todas las Suscripciones</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Origen</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {allSubscriptions.map((subscription) => (
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {subscription.email}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                  {subscription.type}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`px-2 py-1 text-xs font-semibold rounded-full ${
                    subscription.status === 'active' 
                      ? 'bg-green-100 text-green-800' 
                      : 'bg-red-100 text-red-800'
                  }`}>
                    {subscription.status}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">
                  {subscription.source}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {new Date(subscription.subscribed_at).toLocaleDateString('es-ES')}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  {subscription.status === 'active' ? (
                    <button 
                      class="text-red-600 hover:text-red-800 transition-colors unsubscribe-btn" 
                      data-email={subscription.email}
                      data-type={subscription.type}
                    >
                      Dar de baja
                    </button>
                  ) : (
                    <span class="text-gray-400">Dado de baja</span>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Contenedor de notificaciones -->
  <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
</AdminSidebarLayout>

<script src="/src/scripts/admin/newsletter.ts"></script>
